# 6.5 Практическая работа: Асинхронная система на Kafka

### Запуск приложения

1.  Соберите проект:
    `.\gradlew clean build`

2.  Запустите Docker-контейнеры (команда для PowerShell, сохраняет лог в файл):
    `.\docker\docker-start.cmd | Tee-Object -FilePath "docker\docker-log.txt"`

3.  Отправьте тестовый запрос для создания заказа:
    ```sh
    curl -X POST -H "Content-Type: application/json" -d \'\'\'{"productName": "Test Product", "quantity": 123}\'\'\' http://localhost:8081/api/orders
    ```

4.  Проверьте логи работы в файле `logs/application.log`.

5.  **Для включения многопоточной обработки**, 
    - 1.нужно изменить количество партиций в configuration обоих сервисов с 1 до 3 например.
    - 2.нужно изменить **concurrency = "1"** на 3, в **OrderListener**
    Это позволит сервису `order-status-service` читать сообщения из топика `order-topic` в 3 потока.

6.  После включения многопоточности время выполнения под нагрузкой 100 запросов (Postman) уменьшится.

---

### Описание работы системы

Создали систему, где сервисы не общаются друг с другом напрямую. Вместо этого они общаются асинхронно через брокер сообщений — **Apache Kafka**.

## Шаг 1: Запрос от пользователя
*   **Кто:** Пользователь (или Postman/curl).
*   **Действие:** Отправляет POST-запрос с данными заказа (например, `{"productName": "Book", "quantity": 1}`) на эндпоинт `/api/orders`.
*   **Куда:** В сервис `order-service`.

## Шаг 2: Первая отправка в Kafka
*   **Кто (Продюсер):** `order-service`.
*   **Действие:** Получает запрос, создает из него событие `OrderStatusEvent` со статусом `CREATED`.
*   **В какой топик:** Отправляет это событие в топик `order-topic`.

## Шаг 3: Обработка статуса
*   **Кто (Потребитель):** `order-status-service`.
*   **Действие:** Слушает топик `order-topic`, получает оттуда событие.

## Шаг 4: Ответная отправка в Kafka
*   **Кто (Продюсер):** `order-status-service`.
*   **Действие:** Обрабатывает событие (меняет статус на `COMPLETED`, устанавливает дату) и отправляет это обновленное событие обратно в Kafka.
*   **В какой топик:** Отправляет обновленное событие в топик `order-status-topic`.

## Шаг 5: Завершение цикла
*   **Кто (Потребитель):** `order-service`.
*   **Действие:** Слушает топик `order-status-topic`, получает оттуда финальное событие с обновленным статусом и выводит его в лог.
